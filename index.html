<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>POOL / Бассейн</title>
  <link href="https://fonts.cdnfonts.com/css/press-start-2p" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /*
     * 1995 LA Vibe: 2D Noir / Synthwave / Phonk
     */

    /* ========== ЦВЕТА (The Neon Glow) ========== */
    :root {
      --bg: #07070F; /* Глубокий темный фон */
      --neon-magenta: #FF00FF; /* Основной неоновый (Пурпурный) */
      --neon-cyan: #00FFFF; /* Акцентный неоновый (Бирюзовый) */
      --neon-green: #00FF7F; /* Дополнительный (Таймер/Пул) */
      --text-light: #E0E0E0;
    }

    /* ========== БАЗА & VHS ЭФФЕКТ ========== */
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin:0; padding:0;
      background: var(--bg);
      color: var(--neon-cyan);
      font-family: 'Press Start 2P', Courier, monospace;
      overflow-x:hidden; overflow-y:auto;
      position:relative;
      min-height:100vh;
      /* Неоновый фон, имитирующий отражение воды */
      background-image:
        radial-gradient(circle at 50% 80%, rgba(7,7,15,1) 50%, rgba(255,0,255,0.05) 80%),
        linear-gradient(to bottom, rgba(0,255,255,0.08) 0%, transparent 50%),
        linear-gradient(to top, rgba(255,0,255,0.08) 0%, transparent 50%);
      background-blend-mode: overlay;
    }
    
    /* Эффект VHS/Grain (зерно) */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 1000;
      /* Очень мелкое зерно */
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAGCAYAAADgzO9IAAAASklEQVQIW2NkgABGSgU4/99/Q88ZgYg/g/D/f+P/f38+MjCwF+rGABi4wAkgv+3lRjV/g7I/A8n///1/YQ1A/4tQ5QBgYABRgwBGSAGqY8d5YAAAAABJRU5ErkJggg==');
      opacity: 0.05; 
    }

    .container{
      max-width:380px; width:100%;
      margin: 0 auto;
      padding: 18px;
    }

    /* ========== ВЕРХ (заголовок + контролы) ========== */
    .top-panel{
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:center; align-items:center;
      padding:12px;
      background: rgba(0,0,0,0.6);
      border: 2px solid var(--neon-magenta);
      margin-bottom:14px;
      /* Неоновое свечение */
      box-shadow: 0 0 16px rgba(255,0,255,0.4); 
      animation: neonPulse 3s infinite alternate;
    }

    .title{
      flex-basis:100%;
      text-align:center;
      color: var(--neon-magenta);
      /* Двойной неоновый эффект */
      text-shadow: 0 0 4px var(--neon-magenta), 0 0 16px var(--neon-magenta), 0 0 24px var(--neon-cyan);
      font-size:1.1rem;
      margin:0; padding-bottom:5px;
      border-bottom: 1px solid rgba(255,0,255,0.3);
    }

    .top-controls{
      display:flex; gap:10px; align-items:center; justify-content:center; width:100%;
      padding-top:10px;
    }

    .total-pool{
      background:#000;
      border:2px solid var(--neon-green);
      color:var(--neon-green);
      padding:8px 10px;
      font-size:0.75rem;
      text-align:center;
      flex:1 1 50%; 
      box-shadow: 0 0 8px rgba(0,255,127,0.5);
    }

    .contribute-button{
      background: var(--neon-magenta);
      border:2px solid var(--neon-cyan);
      color:var(--bg); 
      padding:10px 12px;
      cursor:pointer;
      font-size:0.75rem;
      flex:1 1 30%;
      white-space:nowrap;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 0 10px rgba(255,0,255,0.6);
    }
    .contribute-button:hover{ transform: scale(1.02); box-shadow: 0 0 18px var(--neon-magenta); }
    .contribute-button:active{ transform: scale(.97); }

    @keyframes neonPulse {
      0% { box-shadow: 0 0 14px rgba(255,0,255,0.4), 0 0 8px rgba(0,255,255,0.2); }
      100% { box-shadow: 0 0 20px rgba(255,0,255,0.6), 0 0 12px rgba(0,255,255,0.3); }
    }

    /* ========== Таймер (HUD Style) ========== */
    .timer{
      background: rgba(0,0,0,0.6);
      border:3px solid var(--neon-green);
      color:var(--neon-green);
      padding:12px;
      text-align:center;
      margin:16px 0;
      font-size:1.2rem;
      box-shadow: 0 0 10px rgba(0,255,127,0.7);
      animation: timerFlicker 1.5s infinite alternate;
    }
    @keyframes timerFlicker { 0%{opacity:.95; text-shadow:none;} 100%{opacity:1; text-shadow:0 0 6px var(--neon-green);} }

    /* ========== Список участников ========== */
    .participants{ margin: 12px 0; display:block; }
    .participant-card{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px;
      background: rgba(0,0,0,0.7);
      padding:10px;
      margin-bottom:10px;
      border:1px solid rgba(0,255,255,0.1);
      box-shadow: 0 0 4px rgba(0,255,255,0.15);
      font-size:0.75rem;
    }
    .participant-left { display:flex; flex-direction:column; gap:4px; }
    .participant-nick{ color:var(--neon-cyan); font-weight:700; text-shadow:0 0 4px rgba(0,255,255,0.4); }
    .participant-amount{ color:#FFFF00; font-weight:700; text-shadow:0 0 4px #FFFF00; }
    .participant-chance{ color:var(--text-light); font-size:0.7rem; opacity:0.9; }

    /* ========== Рулетка (Noir Diagram) ========== */
    .roulette{
      background: rgba(0,0,0,0.6);
      padding:16px 12px;
      margin:16px 0 40px;
      border:2px solid var(--neon-cyan);
      text-align:center;
      box-shadow: 0 0 16px rgba(0,255,255,0.4);
    }
    .roulette-value{
        color:var(--neon-magenta);
        margin-bottom:12px; display:block;
        font-size:0.8rem;
        text-shadow: 0 0 8px var(--neon-magenta);
    }
    .roulette-diagram{
      width: min(240px, 90vw);
      height: 0;
      padding-bottom: min(240px, 90vw);
      margin: 0 auto;
      border-radius:50%;
      overflow:hidden;
      position:relative;
    }
    #roulette-canvas {
        position:absolute;
        top:0; bottom:0; left:0; right:0;
        width:100%;
        height:100%;
    }

    /* ========== МОДАЛ ФАЛЬБЭК (Noir Overlay) ========== */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal {
      background: #111; border-radius:0; padding:18px;
      width: min(340px, calc(100% - 32px));
      box-shadow: 0 0 20px rgba(0,255,255,0.4);
      border:2px solid var(--neon-cyan);
      color:var(--text-light);
    }
    .modal h4{ margin:0 0 12px 0; color:var(--neon-magenta); text-shadow:0 0 8px var(--neon-magenta); font-size:0.9rem;}
    .address-box{ background:#000; padding:10px; border:1px dashed var(--neon-green); margin:8px 0; color:#fff; font-family:monospace; font-size:0.8rem; word-break:break-all;}
    .modal .row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .btn { padding:10px 12px; cursor:pointer; border:none; font-family: 'Press Start 2P', monospace; font-size:0.7rem;}
    .btn-copy{ background:var(--neon-cyan); color:#111; box-shadow:0 0 6px var(--neon-cyan); }
    .btn-close{ background:#222;color:#fff; border:1px solid #444; }

  </style>
</head>
<body>
  <div class="container">
    <div class="top-panel">
      <h2 class="title">POOL / Бассейн</h2>

      <div class="top-controls">
        <input id="total-pool" class="total-pool" value="0.00 USDT" readonly />
        <button id="contributeBtn" class="contribute-button">Внести пул</button>
      </div>
    </div>

    <div id="timer" class="timer">Ожидание старта</div>

    <div id="participants-list" class="participants"></div>

    <div class="roulette">
      <span id="roulette-value" class="roulette-value">Шанс лидера: 0%</span>
      <div class="roulette-diagram">
        <canvas id="roulette-canvas"></canvas>
      </div>
    </div>
  </div>

  <div id="modal-backdrop" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <h4>Автоматический перевод не сработал</h4>
      <div>Пожалуйста, переведите минимум <strong>0.15 USDT (TON)</strong> на адрес ниже.</div>
      <div id="addr" class="address-box"></div>
      <div class="row">
        <button id="copyBtn" class="btn btn-copy">Копировать адрес</button>
        <button id="closeModal" class="btn btn-close">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * ДАННЫЕ / СТЕЙТ
     ***********************/
    let participantsData = [];
    let poolStarted = false;
    let timeLeft = 900; // 15 мин
    const MIN_AMOUNT = 0.15;
    // ВАЖНО: ЭТОТ АДРЕС ВЫ ДОЛЖНЫ ИСПРАВИТЬ В bot.py и ЗДЕСЬ
    const YOUR_ADDRESS = "EQC47n_s4qQ2-B0tM0D170J8qg529P7vH29Yw37z0X_75r"; // <-- ПРИМЕР! ЗАМЕНИТЕ НА СВОЙ EQ/UQ АДРЕС

    /***********************
     * UI ЭЛЕМЕНТЫ
     ***********************/
    const totalInput = document.getElementById('total-pool');
    const contributeBtn = document.getElementById('contributeBtn');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const addrBox = document.getElementById('addr');
    const copyBtn = document.getElementById('copyBtn');
    const closeModal = document.getElementById('closeModal');
    
    // Получаем Telegram User ID, если Web App загрузился
    let telegramUserId = 0;
    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
        telegramUserId = Telegram.WebApp.initDataUnsafe.user.id;
    }

    /***********************
     * КНОПКА ВНЕСТИ ПУЛ (С ИСПОЛЬЗОВАНИЕМ TELEGRAM.WebApp.openLink)
     ***********************/
    function showFallbackModal(address){
      addrBox.textContent = address;
      modalBackdrop.style.display = 'flex';
      copyBtn.onclick = async () => {
        try { 
          await navigator.clipboard.writeText(address); 
          copyBtn.textContent = "СКОПИРОВАНО"; 
          setTimeout(()=>copyBtn.textContent="Копировать адрес",1300); 
        }
        catch(e){ 
          copyBtn.textContent="ОШИБКА"; 
          setTimeout(()=>copyBtn.textContent="Копировать адрес",1300); 
        }
      };
      closeModal.onclick = () => modalBackdrop.style.display = 'none';
    }

    function contribute(){
      // Минимальная сумма 0.15 USDT (в нано-TON это 150 000 000)
      const amountNano = 150000000; 
      
      // КОММЕНТАРИЙ: Здесь мы передаем ID пользователя. 
      // Бот будет искать транзакции с этим комментарием.
      const comment = "pool-id-" + telegramUserId; 
      
      // Формируем Deeplink. Param 'text' используется как комментарий/сообщение.
      // Кодируем комментарий для URL.
      const tonLink = `ton://transfer/${YOUR_ADDRESS}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;

      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.openLink) {
        // Надежный метод Telegram Web App
        Telegram.WebApp.openLink(tonLink);
      } else {
        // Фальбэк, если Telegram Web App не загрузился (показываем модал с адресом)
        showFallbackModal(YOUR_ADDRESS);
      }
    }

    contributeBtn.addEventListener('click', contribute);

    // ... (Остальной код (Таймер, Рендер, Рулетка) остается без изменений, но его нужно добавить в ваш index.html)
    
    /***********************
     * ТАЙМЕР
     ***********************/
    function updateTimer(){
      const el = document.getElementById('timer');
      if (poolStarted) {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        el.innerText = `ДО РОЗЫГРЫША: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        timeLeft--;
        if (timeLeft <= 0) {
          poolStarted = false;
          timeLeft = 900;
          el.innerText = "ПУЛ ЗАВЕРШЕН";
        }
      } else {
        el.innerText = "ОЖИДАНИЕ СТАРТА";
      }
    }

    /***********************
     * ОБНОВЛЕНИЕ УЧАСТНИКОВ (МОК-ДАННЫЕ, ЗАМЕНИТЬ НА FETCH)
     ***********************/
    // Вспомогательная функция для безопасности
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }


    function renderParticipants(){
      const participantsList = document.getElementById('participants-list');
      const rouletteValue = document.getElementById('roulette-value');
      
      participantsList.innerHTML = '';
      const total = participantsData.reduce((s,p)=>s+p.amount,0);
      totalInput.value = `${total.toFixed(2)} USDT`;
      if (total === 0) {
        rouletteValue.textContent = 'Шанс лидера: 0%';
        drawRoulette([],0);
        return;
      }

      // Расчет шансов 
      let totalChance = 0;
      participantsData.forEach(p => {
        p.chance = +( (p.amount/total)*100 ).toFixed(1);
        totalChance += p.chance;
      });
      
      // Сортировка для определения лидера
      participantsData.sort((a,b)=>b.amount - a.amount);

      // Рендер карточек
      participantsData.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'participant-card';
        card.innerHTML = `
          <div class="participant-left">
            <div class="participant-nick">${escapeHtml(p.id)}</div>
            <div class="participant-chance">${p.chance}% шанс</div>
          </div>
          <div class="participant-amount">${p.amount.toFixed(2)} USDT</div>
        `;
        participantsList.appendChild(card);
      });

      rouletteValue.textContent = `Шанс лидера: ${participantsData[0].chance}%`;
      drawRoulette(participantsData, total);
    }
    
    // ... (Функция drawRoulette и resizeCanvasForHiDPI также должны быть в index.html, но для краткости не дублирую их здесь, они были в предыдущем ответе.)
    
    /***********************
     * РИСОВАНИЕ РУЛЕТКИ (NEON DIAGRAM)
     ***********************/
    function resizeCanvasForHiDPI(c){
        const dpr = window.devicePixelRatio || 1;
        const rect = c.getBoundingClientRect();
        c.width = Math.round(rect.width * dpr);
        c.height = Math.round(rect.height * dpr);
        const ctx = c.getContext('2d');
        ctx.setTransform(dpr,0,0,dpr,0,0);
        return ctx;
    }

    function drawRoulette(participants, totalPool){
        const canvas = document.getElementById('roulette-canvas');
        const ctx = resizeCanvasForHiDPI(canvas);
        const w = canvas.clientWidth, h = canvas.clientHeight;
        const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 4;

        ctx.clearRect(0,0,w,h);

        if (!participants || participants.length===0 || totalPool <= 0){
            ctx.beginPath();
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.arc(cx,cy,radius,0,Math.PI*2);
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgba(0,255,255,0.1)';
            ctx.stroke();
            return;
        }

        const colors = [
            '#FF00FF', '#00FFFF', '#FFFF00', '#00FF7F', '#FF69B4', '#00BFFF'
        ];

        let start = -Math.PI/2;
        for (let i=0;i<participants.length;i++){
            const p = participants[i];
            const angle = (p.amount/totalPool) * Math.PI * 2;
            const color = colors[i % colors.length];
            
            ctx.beginPath();
            ctx.moveTo(cx,cy);
            ctx.arc(cx,cy,radius,start,start+angle);
            ctx.closePath();
            
            ctx.fillStyle = color;
            ctx.shadowColor = color;
            ctx.shadowBlur = 18;
            
            ctx.fill();
            ctx.shadowBlur = 0; 

            start += angle;
        }

        ctx.beginPath();
        ctx.fillStyle = 'rgba(0,0,0,0.85)';
        ctx.arc(cx, cy, radius*0.4, 0, Math.PI*2);
        ctx.fill();

        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(255,0,255,0.3)';
        ctx.shadowColor = '#FF00FF';
        ctx.shadowBlur = 10;
        ctx.stroke();
        ctx.shadowBlur = 0;

        ctx.fillStyle = '#E0E0E0';
        ctx.font = '400 0.6rem "Press Start 2P"';
        ctx.textAlign = 'center';
        
        const leader = participants[0];
        
        ctx.fillText('СЕТКА ШАНСОВ', cx, cy - 8);
        ctx.fillStyle = '#FFFF00';
        ctx.fillText(`${leader.id}: ${leader.chance}%`, cx, cy + 12);
    }
    
    /***********************
     * ЦИКЛ ОБНОВЛЕНИЯ (МОК-ДАННЫЕ)
     ***********************/
    function fetchAndApplyMock(){
      if (participantsData.length === 0) {
        participantsData = [
          {id:'NeonKid', amount:0.30},
          {id:'PoolGirl', amount:0.15},
          {id:'Lucky', amount:0.05}
        ];
        poolStarted = true;
      }
      renderParticipants();
    }

    // Обновляем таймер каждую секунду
    setInterval(()=>updateTimer(), 1000);

    // Обновление данных (имитация fetch) раз в 2 секунды
    setInterval(()=>{
      fetchAndApplyMock(); 
    }, 2000);

    // начальный рендер
    renderParticipants();
    drawRoulette(participantsData, participantsData.reduce((s,p)=>s+p.amount,0));

    // ресайз canvas при изменении размеров окна
    window.addEventListener('resize', ()=> drawRoulette(participantsData, participantsData.reduce((s,p)=>s+p.amount,0)) );

    // Telegram WebApp ready
    if (window.Telegram && Telegram.WebApp) {
      try { 
        Telegram.WebApp.ready(); 
        Telegram.WebApp.expand(); 
      } catch(e){
        console.error('Telegram SDK initialization failed:', e);
      }
    }

  </script>
</body>
</html>
